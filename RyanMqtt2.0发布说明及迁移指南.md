# ğŸš€ RyanMqtt 2.0 å‘å¸ƒ

> **æ›´è½»ã€æ›´å¿«ã€æ›´å®‰å…¨ã€æ›´å¯é **

## ğŸ“¦ å‡çº§è·¯çº¿å›¾æ¦‚è§ˆ

| ç»´åº¦         | å˜æ›´ç±»å‹                                                     | æ ¸å¿ƒä»·å€¼                                                     |
| ------------ | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **åè®®æ ˆ**   | **[Paho MQTT Embedded](https://github.com/eclipse-paho/paho.mqtt.embedded-c)** â†’ **[coreMQTT](https://github.com/FreeRTOS/coreMQTT)** | ç¤¾åŒºç»´æŠ¤æ´»è·ƒã€æµ‹è¯•è¦†ç›–å®Œå–„ï¼Œä¸º [**MQTT 5.0**](https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html) æä¾›å¯æ‰©å±•æ€§åŸºç¡€ |
| **ä»£ç è§„èŒƒ** | å¼•å…¥ **[clang-tidy](https://clang.llvm.org/extra/clang-tidy/#clang-tidy)** å’Œ **[Cppcheck](https://cppcheck.sourceforge.io/)** è¿›è¡Œé™æ€åˆ†æ | **é«˜è´¨é‡ä»£ç ä¿éšœ**ï¼Œæ¥è¿‘è¯­æ³•çº§"**é›¶ç¼ºé™·**"ï¼Œæ˜¾è‘—æå‡å¯ç»´æŠ¤æ€§ |
| **ä»£ç å®¡æŸ¥** | ä½¿ç”¨ **[coderabbitai](https://www.coderabbit.ai)** å’Œ **[Copilot](https://github.com/features/copilot)** è¾…åŠ©ç¼–ç ä¸ä»£ç å®¡æŸ¥ | **AIè¾…åŠ©å¼€å‘ä¸å®¡æŸ¥**ï¼ŒæŒç»­æå‡ä»£ç è´¨é‡ï¼Œæ„ç­‘å®‰å…¨é˜²çº¿         |
| **å†…å­˜ç®¡ç†** | å›ºå®šç¼“å†²åŒº â†’ **åŠ¨æ€æŒ‰éœ€åˆ†é…**                                | æŒ‰éœ€ç”³è¯·ï¼Œé™ä½å†…å­˜å ç”¨                                       |
| **çº¿ç¨‹æ¨¡å‹** | æ›´å®Œå–„çš„çº¿ç¨‹å®‰å…¨                                             | æ”¯æ’‘å¤æ‚çº¿ç¨‹åº”ç”¨åœºæ™¯ï¼Œæœç»ç«æ€é£é™©                           |
| **æµ‹è¯•ä½“ç³»** | æ–°å¢ 7 å¤§ä¸“é¡¹æµ‹è¯•                                            | è¦†ç›–å¹¿æ³›åœºæ™¯ï¼Œå…¨é“¾è·¯å†…å­˜æ³„æ¼æ£€æµ‹ï¼Œå¼ºåŒ–ç¨³å®šæ€§ä¸å¯é æ€§         |

## ğŸ— æ¶æ„ä¸åº•å±‚èƒ½åŠ›å˜æ›´

### 1. MQTT åè®®æ ˆå‡çº§

- ä» **[Paho MQTT Embedded](https://github.com/eclipse-paho/paho.mqtt.embedded-c)** åˆ° **[coreMQTT](https://github.com/FreeRTOS/coreMQTT)**
- **[coreMQTT](https://github.com/FreeRTOS/coreMQTT)** ç¤¾åŒºæ´»è·ƒåº¦é«˜ã€ç»´æŠ¤é¢‘ç¹ã€æµ‹è¯•è¦†ç›–æ›´å…¨é¢
- æ›´çµæ´»çš„ç¼“å†²åŒºç®¡ç†ç­–ç•¥
- ä¸º [**MQTT 5.0**](https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html) æ‰©å±•å¥ å®šå®ç°åŸºç¡€

### 2. å†…å­˜ç®¡ç†æ›´æ”¹ä¸ºåŠ¨æ€ç¼“å†²åŒº

- ç§»é™¤å›ºå®š `recvBuffer` / `sendBuffer` é…ç½®
- é‡‡ç”¨**æŒ‰éœ€åŠ¨æ€åˆ†é…**ï¼Œé™ä½è¿è¡Œå†…å­˜å ç”¨

### 3. çº¿ç¨‹å®‰å…¨å¼ºåŒ–

- å…¨é¢å®¡æŸ¥å…¬å…± API ä¸å…±äº«èµ„æºè®¿é—®è·¯å¾„
- ç²¾ç»†åŒ–æ§åˆ¶é”ç²’åº¦ï¼Œæ¶ˆé™¤ç«æ€å¹¶ä¼˜åŒ–æ€§èƒ½
- åœ¨é«˜å¹¶å‘ã€å¤šå®¢æˆ·ç«¯ã€å¤šçº¿ç¨‹åœºæ™¯ä¸‹é€šè¿‡ä¸“é¡¹å‹åŠ›æµ‹è¯•

## ğŸ“ˆ å…¬å…± API å˜åŒ–

### æ–°å¢æ¥å£

```c
// æ‰¹é‡è®¢é˜…/å–æ¶ˆè®¢é˜…
extern RyanMqttError_e RyanMqttSubscribeMany(RyanMqttClient_t *client, int32_t count,
					     RyanMqttSubscribeData_t subscribeManyData[]);
extern RyanMqttError_e RyanMqttUnSubscribeMany(RyanMqttClient_t *client, int32_t count,
					       RyanMqttUnSubscribeData_t unSubscribeManyData[]);

// å¸¦ç”¨æˆ·æ•°æ®çš„å‘å¸ƒ
extern RyanMqttError_e RyanMqttPublishAndUserData(RyanMqttClient_t *client, char *topic, uint16_t topicLen,
						  char *payload, uint32_t payloadLen, RyanMqttQos_e qos,
						  RyanMqttBool_e retain, void *userData);

// çº¿ç¨‹å®‰å…¨çš„è®¢é˜…æŸ¥è¯¢,å¿…é¡»ä»…é€šè¿‡ RyanMqttSafeFreeSubscribeResources é‡Šæ”¾ã€‚
extern RyanMqttError_e RyanMqttGetSubscribeSafe(RyanMqttClient_t *client, RyanMqttMsgHandler_t **msgHandles,
						int32_t *subscribeNum);
extern RyanMqttError_e RyanMqttSafeFreeSubscribeResources(RyanMqttMsgHandler_t *msgHandles, int32_t subscribeNum);

// è®¢é˜…æ•°é‡æŸ¥è¯¢
extern RyanMqttError_e RyanMqttGetSubscribeTotalCount(RyanMqttClient_t *client, int32_t *subscribeTotalCount);
```

### æ–°å¢åŠŸèƒ½ä»·å€¼

| æ¥å£                     | ç”¨é€”                  | ä¼˜åŠ¿                                   |
| ------------------------ | --------------------- | -------------------------------------- |
| `SubscribeMany`          | æ‰¹é‡è®¢é˜…/å–æ¶ˆå¤šä¸ªä¸»é¢˜ | å‡å°‘ç½‘ç»œå¾€è¿”ï¼Œæå‡ååæ•ˆç‡             |
| `PublishAndUserData`     | å‘å¸ƒæ¶ˆæ¯é™„å¸¦ä¸Šä¸‹æ–‡    | å›è°ƒä¸­å¯ç›´æ¥è¯»å–ç”¨æˆ·æ•°æ®ï¼Œç®€åŒ–çŠ¶æ€ç®¡ç† |
| `GetSubscribeSafe`       | å®‰å…¨æŸ¥è¯¢è®¢é˜…çŠ¶æ€      | å¤šçº¿ç¨‹åœºæ™¯ä¸‹æ— éœ€è°ƒç”¨æ–¹åŠ é”ï¼ˆå†…éƒ¨å·²åŒæ­¥ï¼‰                  |
| `GetSubscribeTotalCount` | è·å–è®¢é˜…æ€»æ•°é‡        | ä¾¿äºç›‘æ§ä¸èµ„æºè°ƒåº¦                     |

## ğŸ”§ å¹³å°æŠ½è±¡å±‚ä¼˜åŒ–

### 1. ç»Ÿä¸€æ—¶é—´æ¥å£

```c
uint32_t platformUptimeMs(void);
```

- è·¨å¹³å°è¿”å›ç³»ç»Ÿå¯åŠ¨ä»¥æ¥çš„æ¯«ç§’æ—¶é—´æˆ³
- å†…éƒ¨å·²å¤„ç† 32 ä½æ•´æ•°å›ç»•é—®é¢˜ï¼Œç¡®ä¿é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§

### 2. ç½‘ç»œæ”¶å‘æ¨¡å‹ç®€åŒ–

- æ”¶å‘æ¥å£æ”¹ä¸º**å•æ¬¡è°ƒç”¨è¯­ä¹‰**ï¼Œå‡å°‘å†—ä½™å¾ªç¯ä¸åˆ†æ”¯
- è¿”å›å€¼ç”±`é”™è¯¯ç `è°ƒæ•´ä¸º`å®é™…ä¼ è¾“å­—èŠ‚æ•°`ï¼Œæ›´è´´è¿‘åº•å±‚è¡Œä¸º
- å¼‚å¸¸æ¢å¤è·¯å¾„æ›´æ˜ç¡®å¯æ§

## ğŸ§ª æµ‹è¯•ä½“ç³»å…¨é¢å‡çº§

æ–°å¢ **7 å¤§ç±»ä¸“é¡¹æµ‹è¯•ç”¨ä¾‹**ï¼Œè¦†ç›–ä»åŸºç¡€åŠŸèƒ½åˆ°æé™å‹åŠ›åœºæ™¯çš„å…¨æµç¨‹éªŒè¯ï¼š

| æµ‹è¯•ç±»åˆ«                  | æµ‹è¯•ç›®æ ‡                          |
| ------------------------- | --------------------------------- |
| 1. å®¢æˆ·ç«¯é”€æ¯å‹åŠ›æµ‹è¯•     | éªŒè¯èµ„æºé‡Šæ”¾çš„å¹‚ç­‰æ€§ä¸å®Œæ•´æ€§      |
| 2. å¿ƒè·³ä¸è¶…æ—¶å¤„ç†         | Keep-Aliveã€PINGREQ/RESP æœºåˆ¶éªŒè¯ |
| 3. æ¶ˆæ¯é“¾è·¯å®Œæ•´æ€§         | QoS 0/1/2 æ¶ˆæ¯ç«¯åˆ°ç«¯å¯é æ€§éªŒè¯    |
| 4. è‡ªåŠ¨/æ‰‹åŠ¨é‡è¿æœºåˆ¶      | çŠ¶æ€æœºæ­£ç¡®æ€§ä¸è¿æ¥æ¢å¤èƒ½åŠ›        |
| 5. æ‰¹é‡/é‡å¤è®¢é˜…æµ‹è¯•      | è®¢é˜…è¡¨ä¸€è‡´æ€§ã€å†…å­˜å®‰å…¨ã€å»é‡é€»è¾‘  |
| 6. å¤šå®¢æˆ·ç«¯é«˜å¹¶å‘æµ‹è¯•     | 20+ å®¢æˆ·ç«¯å¹¶å‘è¿è¡Œç¨³å®šæ€§          |
| 7. å•å®¢æˆ·ç«¯å¤šçº¿ç¨‹å…±äº«æµ‹è¯• | é”æœºåˆ¶ã€æ•°æ®ä¸€è‡´æ€§ã€ç«æ€é˜²æŠ¤      |

#### ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

- **åŸºç¡€è¿æ¥**ï¼š100 æ¬¡å¾ªç¯è¿æ¥/æ–­å¼€ï¼Œæ··åˆ QoS æ¶ˆæ¯ä¸è®¢é˜…
- **æ¶ˆæ¯æµæ§**ï¼šè¿ç»­å‘é€QoS0/1/2ç­‰çº§ 1000 æ¡æ¶ˆæ¯ï¼Œæ··åˆ QoS å‹åŠ›æµ‹è¯•
- **è®¢é˜…ç®¡ç†**ï¼šæ‰¹é‡ã€å¤§é‡ã€é‡å¤ã€æ··åˆ QoS è®¢é˜…ä¸å–æ¶ˆ
- **å¹¶å‘å‹æµ‹:**
  - å•å®¢æˆ·ç«¯ 20 çº¿ç¨‹ Ã— å„ 1000 æ¡ QoS1/2 æ¶ˆæ¯
  - å¤šå®¢æˆ·ç«¯ 20 å¹¶å‘å®ä¾‹è¿›è¡ŒåŒå‘å‘å¸ƒ/è®¢é˜…
- **å¯é æ€§**ï¼šé•¿è¿æ¥ã€å¼±ç½‘ã€Keep-Aliveã€é‡è¿æœºåˆ¶éªŒè¯
- **èµ„æºå®‰å…¨**ï¼šå…¨é“¾è·¯å†…å­˜æ³„æ¼ã€å¥æŸ„æ³„æ¼æ£€æµ‹

## ğŸ“Š ä»£ç è´¨é‡ä¸è§„èŒƒä½“ç³»

#### âœ… å·¥å…·é“¾å…¨é¢é›†æˆ

| å·¥å…·                                                         | ç”¨é€”                                       |
| ------------------------------------------------------------ | ------------------------------------------ |
| [ClangFormat](https://clang.llvm.org/docs/ClangFormat.html)  | ç»Ÿä¸€ä»£ç é£æ ¼ï¼ˆLLVM æ ‡å‡†ï¼‰                  |
| [clang-tidy](https://clang.llvm.org/extra/clang-tidy/#clang-tidy) | é™æ€åˆ†ææ½œåœ¨ç¼ºé™·ï¼ˆç©ºæŒ‡é’ˆã€èµ„æºæ³„æ¼ç­‰ï¼‰     |
| [Cppcheck](https://cppcheck.sourceforge.io/)                 | æ·±åº¦æ‰«æå†…å­˜ä¸èµ„æºé—®é¢˜                     |
| ç¼–è¯‘å™¨è­¦å‘Š                                                   | `-Wall -Wextra -Weffc++ -Weverything` å…¨å¼€ |

#### âœ… æ£€æŸ¥é‡ç‚¹è¦†ç›–

- å†…å­˜å®‰å…¨ï¼šæœç»æ³„æ¼ã€è¶Šç•Œã€æ‚¬ç©ºæŒ‡é’ˆ
- æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘å†—ä½™æ‹·è´ä¸ä½æ•ˆç®—æ³•
- å¯è¯»æ€§ï¼šå‘½åè§„èŒƒã€æ³¨é‡Šå®Œæ•´ã€é€»è¾‘æ¸…æ™°

> âœ… **æˆæœ**ï¼šå®ç°æ¥è¿‘è¯­æ³•çº§"**é›¶ç¼ºé™·**"ï¼Œé•¿æœŸç»´æŠ¤æˆæœ¬å¤§å¹…é™ä½

## ğŸ”’ å®‰å…¨æ€§ä¸å¯é æ€§å…¨é¢æå‡

- å…¨é¢å®¡æŸ¥å…¬å…± API
- æ ¸å¿ƒæ•°æ®ç»“æ„è®¿é—®å‡å—åŒæ­¥æœºåˆ¶ä¿æŠ¤
- åŠ¨æ€å†…å­˜ç­–ç•¥æ›´å¥å£®ï¼Œå¼‚å¸¸è·¯å¾„ä¹Ÿèƒ½å®‰å…¨é‡Šæ”¾
- è¾“å…¥éªŒè¯ä¸è¾¹ç•Œæ£€æŸ¥æ›´ä¸¥æ ¼ï¼Œé˜²å¾¡æ€§ç¼–ç¨‹å¢å¼º
- ç½‘ç»œå¼‚å¸¸å¤„ç†æ›´å®Œå–„ï¼Œå¼±ç½‘ç¯å¢ƒä¸‹è¿æ¥æ¢å¤æ›´å¿«
- é”™è¯¯æ¢å¤è·¯å¾„æ›´ç¨³å¥ï¼Œè¶…æ—¶ç­–ç•¥æ›´ç²¾å‡†

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ RyanMqtt 2.0 æ˜¯ä¸€æ¬¡å…·æœ‰é‡Œç¨‹ç¢‘æ„ä¹‰çš„å‡çº§ï¼š

1. **æŠ€æœ¯æ ˆç°ä»£åŒ–**ï¼šè¿ç§»è‡³ **[coreMQTT](https://github.com/FreeRTOS/coreMQTT)**ï¼Œæ‹¥æŠ±æ›´æ´»è·ƒçš„ç”Ÿæ€ä¸æœªæ¥æ‰©å±•èƒ½åŠ›

2. **æ¶æ„æ›´æ¸…æ™°**ï¼šæ¨¡å—é«˜åº¦è§£è€¦ï¼ŒæŠ½è±¡è®¾è®¡æ›´åˆç†

3. **è´¨é‡æ›´å¯ä¿¡**ï¼š7 ç±»ä¸“é¡¹æµ‹è¯• + é™æ€åˆ†æ + AI å®¡æŸ¥æ„ç­‘å¼ºå¤§é˜²çº¿

4. **æ€§èƒ½å†ä¼˜åŒ–**ï¼šæ›´ä½èµ„æºå ç”¨ã€æ›´é«˜ååæ•ˆç‡

5. **ç»´æŠ¤æ›´è½»æ¾**ï¼šç»Ÿä¸€ä»£ç è§„èŒƒã€å¹³å°æŠ½è±¡é™ä½é•¿æœŸå¼€å‘æˆæœ¬

   

# ğŸ”„ ä» 1.x è¿ç§»è‡³ 2.x

> RyanMqtt 2.0 åœ¨è®¾è®¡ä¸Šå°½é‡å‡å°‘ç ´åæ€§å˜æ›´ã€‚å‡çº§è¿‡ç¨‹æä¸ºç®€å•ï¼š
>

ä» **V1.x** å‡çº§è‡³ **V2.x** ä»…éœ€ï¼š

**åˆ é™¤** `RyanMqttClientConfig_t` **ç»“æ„ä½“ä¸­çš„ä»¥ä¸‹å››ä¸ªå­—æ®µ**ï¼š

```c
char *recvBuffer;        // MQTT æ¥æ”¶ç¼“å†²åŒºï¼ˆå·²åºŸå¼ƒï¼‰
char *sendBuffer;        // MQTT å‘é€ç¼“å†²åŒºï¼ˆå·²åºŸå¼ƒï¼‰
uint32_t recvBufferSize; // æ¥æ”¶ç¼“å†²åŒºå¤§å°ï¼ˆå·²åºŸå¼ƒï¼‰
uint32_t sendBufferSize; // å‘é€ç¼“å†²åŒºå¤§å°ï¼ˆå·²åºŸå¼ƒï¼‰
```

å—å½±å“çš„æ¥å£ä»…æœ‰ä¸€ä¸ªï¼š

```c
RyanMqttError_e RyanMqttSetConfig(RyanMqttClient_t *client, RyanMqttClientConfig_t *clientConfig);
```